<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Code with Pattern Modal - Library Version</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pattern Drawer Library CSS -->
    <link rel="stylesheet" href="pattern-drawer.css">
    <style>
        .pattern-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* Custom modal styles to work with the library */
        .modal-pattern-container {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-base-100 min-h-screen p-4">
    <div class="max-w-md mx-auto">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-center justify-center mb-6">User Code</h2>
                
                <!-- Input Section -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Enter Code</span>
                    </label>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="userCode" 
                            placeholder="Enter user code" 
                            class="input input-bordered flex-1 font-mono"
                        />
                        <button 
                            class="btn btn-square btn-outline" 
                            onclick="openPatternModal()"
                            title="Draw Pattern"
                        >
                            <svg class="pattern-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="5" cy="5" r="2"/>
                                <circle cx="12" cy="5" r="2"/>
                                <circle cx="19" cy="5" r="2"/>
                                <circle cx="5" cy="12" r="2"/>
                                <circle cx="12" cy="12" r="2"/>
                                <circle cx="19" cy="12" r="2"/>
                                <circle cx="5" cy="19" r="2"/>
                                <circle cx="12" cy="19" r="2"/>
                                <circle cx="19" cy="19" r="2"/>
                                <path d="M5 5L12 12L19 5" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <label class="label">
                        <span class="label-text-alt">Enter code manually or use pattern drawer</span>
                    </label>
                </div>

                <!-- Action Buttons -->
                <div class="card-actions justify-end mt-6">
                    <button class="btn btn-ghost" onclick="clearCode()">Clear</button>
                    <button class="btn btn-primary" onclick="saveCode()">Save Code</button>
                </div>

                <!-- Status Alert -->
                <div id="statusAlert" style="display: none;" class="alert mt-4">
                    <span id="statusMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Pattern Modal -->
    <dialog id="patternModal" class="modal">
        <div class="modal-box max-w-md bg-slate-800 text-white">
            <h3 class="font-bold text-lg mb-6 text-center" id="modalTitle">Draw Lock Pattern</h3>
            
            <!-- Pattern Container - Now handled by the library -->
            <div class="modal-pattern-container">
                <div id="patternContainer"></div>
                
                <!-- Pattern Status -->
                <div id="patternStatus" class="text-center text-sm text-slate-400 mb-4 mt-4">
                    Draw a pattern with at least 4 points
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="modal-action">
                <div id="drawActions">
                    <button class="btn btn-ghost text-white hover:bg-slate-700" onclick="clearPattern()">Clear</button>
                    <button class="btn btn-outline border-slate-600 text-white hover:bg-slate-700" onclick="closePatternModal()">Cancel</button>
                    <button class="btn btn-primary bg-white text-black hover:bg-gray-200 border-white" onclick="applyPattern()">Apply Pattern</button>
                </div>
                <div id="viewActions" style="display: none;">
                    <button class="btn btn-primary bg-white text-black hover:bg-gray-200 border-white" onclick="closePatternModal()">Close</button>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button onclick="closePatternModal()">close</button>
        </form>
    </dialog>

    <!-- Pattern Drawer Library Script -->
    <script type="module">
        import { createPatternDrawer, PatternUtils, PRESETS, THEMES } from './pattern-drawer.js';

        // Application state
        let patternDrawer;
        let currentMode = 'draw'; // 'draw' or 'view'
        let savedUserCode = '';

        // Initialize when page loads
        window.addEventListener('load', () => {
            // Create pattern drawer with modal-optimized configuration
            const config = {
                ...PRESETS.MOBILE_LOCK,
                theme: THEMES.DARK,
                showInfo: true,
                size: 'medium',
                debug: false  // Set to true to see red dots at calculated centers
            };
            
            patternDrawer = createPatternDrawer('#patternContainer', 'MOBILE_LOCK', config);
            
            // Setup event listeners
            setupPatternDrawerEvents();
        });

        // Setup pattern drawer event listeners
        function setupPatternDrawerEvents() {
            patternDrawer.on('patternComplete', (data) => {
                updatePatternStatus(`Pattern ready (${data.pattern.length} points)`);
                
                if (data.complexity) {
                    console.log('Pattern complexity:', data.complexity);
                }
            });

            patternDrawer.on('patternError', (data) => {
                updatePatternStatus(data.error, 'error');
            });

            patternDrawer.on('patternStart', () => {
                updatePatternStatus('Drawing pattern...');
            });

            patternDrawer.on('patternClear', () => {
                updatePatternStatus('Draw a pattern with at least 4 points');
            });
        }

        // Update pattern status display
        function updatePatternStatus(message, type = 'info') {
            const statusEl = document.getElementById('patternStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `text-center text-sm mb-4 mt-4 ${
                    type === 'error' ? 'text-red-400' : 'text-slate-400'
                }`;
            }
        }

        // Utility functions
        function showStatus(message, type = 'info') {
            const alert = document.getElementById('statusAlert');
            const messageEl = document.getElementById('statusMessage');
            
            messageEl.textContent = message;
            alert.className = `alert mt-4 alert-${type}`;
            alert.style.display = 'flex';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // Modal functions
        function openPatternModal() {
            const userCode = document.getElementById('userCode').value.trim();
            
            // Show modal first
            document.getElementById('patternModal').showModal();
            
            // Check if we have a saved pattern to view
            if (savedUserCode && PatternUtils.isPatternSequence(savedUserCode)) {
                currentMode = 'view';
                const sequence = PatternUtils.stringToPattern(savedUserCode);
                setupModalForView(sequence);
            } else {
                currentMode = 'draw';
                setupModalForDraw();
            }
        }

        function setupModalForDraw() {
            document.getElementById('modalTitle').textContent = 'Draw Lock Pattern';
            updatePatternStatus('Draw a pattern with at least 4 points');
            document.getElementById('drawActions').style.display = 'flex';
            document.getElementById('viewActions').style.display = 'none';
            
            // Enable drawing mode
            patternDrawer.draw();
        }

        function setupModalForView(sequence) {
            document.getElementById('modalTitle').textContent = 'Your Lock Pattern';
            document.getElementById('drawActions').style.display = 'none';
            document.getElementById('viewActions').style.display = 'flex';
            
            // Update status for view mode immediately
            const complexity = PatternUtils.calculateComplexity(sequence);
            updatePatternStatus(`Pattern: ${sequence.join(',')} (${complexity.level} complexity)`);
            
            // Show pattern in view mode with proper timing for modal rendering
            setTimeout(() => {
                // Ensure the modal and DOM are fully rendered
                requestAnimationFrame(() => {
                    patternDrawer.view(sequence);
                    
                    // Double-check after a brief delay to ensure lines are drawn
                    setTimeout(() => {
                        if (patternDrawer.getPattern().length > 0) {
                            patternDrawer.refreshCanvas();
                        }
                    }, 100);
                });
            }, 150);
        }

        function closePatternModal() {
            document.getElementById('patternModal').close();
            
            // Reset to draw mode when closing
            if (currentMode !== 'view') {
                patternDrawer.clear();
            }
        }

        function clearPattern() {
            if (currentMode === 'draw') {
                patternDrawer.clear();
            }
        }

        function applyPattern() {
            if (currentMode !== 'draw') return;
            
            const pattern = patternDrawer.getPattern();
            
            if (pattern.length < 4) {
                showStatus('Pattern must have at least 4 points', 'error');
                return;
            }
            
            const patternString = PatternUtils.patternToString(pattern);
            document.getElementById('userCode').value = patternString;
            document.getElementById('patternModal').close();
            patternDrawer.clear();
            showStatus('Pattern applied to code field', 'success');
        }

        // Main actions
        function clearCode() {
            document.getElementById('userCode').value = '';
            savedUserCode = '';
            document.getElementById('statusAlert').style.display = 'none';
        }

        function saveCode() {
            const userCode = document.getElementById('userCode').value.trim();
            
            if (!userCode) {
                showStatus('Please enter a code or draw a pattern', 'error');
                return;
            }

            // Save the code
            savedUserCode = userCode;

            // Simulate saving to database
            console.log('Saving to database user_code field:', userCode);
            
            if (PatternUtils.isPatternSequence(userCode)) {
                const complexity = PatternUtils.calculateComplexity(
                    PatternUtils.stringToPattern(userCode)
                );
                showStatus(
                    `Pattern saved successfully! Complexity: ${complexity.level}. Click the pattern button to view it.`, 
                    'success'
                );
            } else {
                showStatus('Code saved successfully!', 'success');
            }

            // Example API call:
            /*
            fetch('/api/save-user-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_code: userCode })
            });
            */
        }

        // Make functions available globally for onclick handlers
        window.openPatternModal = openPatternModal;
        window.closePatternModal = closePatternModal;
        window.clearPattern = clearPattern;
        window.applyPattern = applyPattern;
        window.clearCode = clearCode;
        window.saveCode = saveCode;
        
        // Debug functions for testing
        window.forceRedraw = () => {
            if (patternDrawer) {
                patternDrawer.forceRedraw();
                console.log('Forced redraw triggered');
            }
        };
        window.debugPatternDrawer = () => patternDrawer;
    </script>
</body>
</html>